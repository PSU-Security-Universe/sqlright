LOAD 'test_rls_hooks';
CREATE TABLE rls_test_permissive (    username        name,    supervisor      name,    data            integer);
INSERT INTO rls_test_permissive VALUES ('regress_r1','regress_s1',4);
INSERT INTO rls_test_permissive VALUES ('regress_r2','regress_s2',5);
INSERT INTO rls_test_permissive VALUES ('regress_r3','regress_s3',6);
CREATE TABLE rls_test_restrictive (    username        name,    supervisor      name,    data            integer);
CREATE POLICY p1 ON rls_test_restrictive USING (true);
INSERT INTO rls_test_restrictive VALUES ('regress_r1','regress_s1',1);
INSERT INTO rls_test_restrictive VALUES ('regress_r2','regress_s2',2);
INSERT INTO rls_test_restrictive VALUES ('regress_r3','regress_s3',3);
CREATE TABLE rls_test_both (    username        name,    supervisor      name,    data            integer);
INSERT INTO rls_test_both VALUES ('regress_r1','regress_s1',7);
INSERT INTO rls_test_both VALUES ('regress_r2','regress_s2',8);
INSERT INTO rls_test_both VALUES ('regress_r3','regress_s3',9);
ALTER TABLE rls_test_permissive ENABLE ROW LEVEL SECURITY;
ALTER TABLE rls_test_restrictive ENABLE ROW LEVEL SECURITY;
ALTER TABLE rls_test_both ENABLE ROW LEVEL SECURITY;
CREATE ROLE regress_r1;
CREATE ROLE regress_s1;
GRANT SELECT,INSERT ON rls_test_permissive TO regress_r1;
GRANT SELECT,INSERT ON rls_test_restrictive TO regress_r1;
GRANT SELECT,INSERT ON rls_test_both TO regress_r1;
GRANT SELECT,INSERT ON rls_test_permissive TO regress_s1;
GRANT SELECT,INSERT ON rls_test_restrictive TO regress_s1;
GRANT SELECT,INSERT ON rls_test_both TO regress_s1;
SET ROLE regress_r1;
EXPLAIN (costs off) SELECT * FROM rls_test_permissive;
SELECT * FROM rls_test_permissive;
INSERT INTO rls_test_permissive VALUES ('regress_r1','regress_s1',10);
INSERT INTO rls_test_permissive VALUES ('regress_r4','regress_s4',10);
SET ROLE regress_s1;
EXPLAIN (costs off) SELECT * FROM rls_test_restrictive;
SELECT * FROM rls_test_restrictive;
INSERT INTO rls_test_restrictive VALUES ('regress_r1','regress_s1',10);
INSERT INTO rls_test_restrictive VALUES ('regress_r4','regress_s4',10);
SET ROLE regress_s1;
EXPLAIN (costs off) SELECT * FROM rls_test_both;
SELECT * FROM rls_test_both;
INSERT INTO rls_test_both VALUES ('regress_r1','regress_s1',10);
INSERT INTO rls_test_both VALUES ('regress_r4','regress_s1',10);
INSERT INTO rls_test_both VALUES ('regress_r4','regress_s4',10);
RESET ROLE;
CREATE POLICY p1 ON rls_test_permissive USING (data % 2 = 0);
DROP POLICY p1 ON rls_test_restrictive;
CREATE POLICY p1 ON rls_test_restrictive USING (data % 2 = 0);
CREATE POLICY p1 ON rls_test_both USING (data % 2 = 0);
SET ROLE regress_r1;
EXPLAIN (costs off) SELECT * FROM rls_test_permissive;
SELECT * FROM rls_test_permissive;
INSERT INTO rls_test_permissive VALUES ('regress_r1','regress_s1',7);
INSERT INTO rls_test_permissive VALUES ('regress_r3','regress_s3',10);
INSERT INTO rls_test_permissive VALUES ('regress_r4','regress_s4',7);
SET ROLE regress_s1;
EXPLAIN (costs off) SELECT * FROM rls_test_restrictive;
SELECT * FROM rls_test_restrictive;
INSERT INTO rls_test_restrictive VALUES ('regress_r1','regress_s1',8);
INSERT INTO rls_test_restrictive VALUES ('regress_r3','regress_s3',10);
INSERT INTO rls_test_restrictive VALUES ('regress_r1','regress_s1',7);
INSERT INTO rls_test_restrictive VALUES ('regress_r4','regress_s4',7);
EXPLAIN (costs off) SELECT * FROM rls_test_both;
SELECT * FROM rls_test_both;
INSERT INTO rls_test_both VALUES ('regress_r1','regress_s1',8);
INSERT INTO rls_test_both VALUES ('regress_r3','regress_s3',10);
INSERT INTO rls_test_both VALUES ('regress_r1','regress_s1',7);
INSERT INTO rls_test_both VALUES ('regress_r4','regress_s4',7);
RESET ROLE;
DROP TABLE rls_test_restrictive;
DROP TABLE rls_test_permissive;
DROP TABLE rls_test_both;
DROP ROLE regress_r1;
DROP ROLE regress_s1;

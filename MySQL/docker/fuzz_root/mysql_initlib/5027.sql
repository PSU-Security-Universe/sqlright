USE test;
RESET MASTER;
RESET REPLICA ALL FOR CHANNEL '';
USE test;
RESET MASTER;
RESET REPLICA ALL FOR CHANNEL '';
START REPLICA ;
CREATE TABLE t1 (c1 INT AUTO_INCREMENT PRIMARY KEY, c2 VARCHAR(5));
INSERT INTO t1(c2) VALUES("a");
XA START 'xa1_t1';
SELECT * FROM t1 WHERE c1 = 2 FOR UPDATE;
UPDATE t1 SET c2 = 'c' WHERE c1 = 2;
XA START 'xa2_t1';
SELECT * FROM t1 WHERE c1 = 1 FOR UPDATE;
UPDATE t1 SET c2 = 'd' WHERE c1 = 1;
SELECT * FROM t1 WHERE c1 = 1 FOR UPDATE;
SELECT * FROM t1 WHERE c1 = 2 FOR UPDATE;
UPDATE t1 SET c2 = 'e' WHERE c1 = 1;
XA END 'xa1_t1';
XA PREPARE 'xa1_t1';
XA COMMIT 'xa1_t1';
XA END 'xa2_t1';
UPDATE t1 SET c2 = 'f' WHERE c1 = 2;
SELECT c1 FROM t1;
XA END 'xa2_t1';
XA ROLLBACK 'xa2_t1';
CREATE TABLE t2 (c1 int);
DROP TABLE t1, t2;
STOP REPLICA ;
SELECT asynchronous_connection_failover_reset();
SELECT asynchronous_connection_failover_reset();
KILL 59;
